<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
        border-radius: 1px;
        color: black;
        table-layout: fixed; /* Ensure table can overflow */
      }

      thead {
        border: 2px solid #ccc;
      }

      th,
      td {
        border: none;
        padding: 15px 10px;
        text-align: center;
        font-size: 14px; /* Standard font size */

        width: 110px; /* Equal width for all columns */
      }
      .column_heading th {
      }

      th {
        background-color: #f2f2f2;
      }

      .row_custom_border {
        border: 2px solid #ccc; /* Adjust color and thickness as needed */
        border-radius: 10px; /* Adjust the border-radius value as needed */
        cursor: pointer;
      }

      .total-amt {
        color: #3e9c35;
        font-weight: bold;
      }

      .heading span {
        color: #746d6d;
        font-size: 11px;
      }

      .table-title {
        display: flex;
        align-items: center;
        margin-top: 18px;
        gap: 10px;
      }

      .tb-title h3 {
        display: inline-block;
        margin: 0;
        font-family: "Franklin Gothic Medium", "Arial Narrow", Arial, sans-serif;
      }
      #hide_name {
        display: none;
      }

      .arrow {
        border: solid black;
        border-width: 0 3px 3px 0;
        display: inline-block;
        padding: 3px;
      }

      .right {
        transform: rotate(-45deg);
        -webkit-transform: rotate(-45deg);
      }

      span.hidden-arrow {
        visibility: hidden;
        background-color: #f2f2f2;
      }

      #load-more-btn {
        background-color: rgb(11 104 106);
        color: #f2f2f2;
        border: none;
        padding: 8px 10px;
        cursor: pointer;
        border-radius: 5px;
        float: inline-end;
        font-size: 14px;
        margin-top: 10px;
      }

      button#load-more-btn:focus {
        outline: none;
      }

      #show-less-btn {
        background-color: rgb(11 104 106);
        color: #f2f2f2;
        border: none;
        padding: 8px 10px;
        cursor: pointer;
        border-radius: 5px;
        font-size: 14px;
        margin-top: 10px;
      }

      button#show-less-btn:focus {
        outline: none;
      }

      .delete-icon {
        cursor: pointer;
        width: 28px;
        height: 28px;
      }

      .delete-icon:hover {
        cursor: pointer;
      }

      /* CSS for the modal popup */
      .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
      }

      .modal-content {
        background-color: #fefefe;
        margin: 10% auto; /* Centered */
        padding: 20px;
        border: 1px solid #888;
        width: 60%; /* Width of modal */
        border-radius: 5px; /* Rounded corners */
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2); /* Add shadow */
      }

      span.close_icon {
        text-align: end;
      }

      .close_icon img {
        width: 45px;
        height: 45px;
      }
      .close_icon:hover,
      .close_icon:focus {
        text-decoration: none;
        cursor: pointer;
      }

      /* Add some spacing between label and input */
      .modal-content label {
        margin-bottom: 8px;
        display: block;
        font-weight: bold;
        font-size: medium;
      }

      .modal-content input {
        width: 100%;
        padding: 8px;
        margin-bottom: 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }

      .modal_header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 20px;
      }

      /* Grid layout for the form */
      #rowDetailsForm {
        display: grid;
        grid-template-columns: 1fr 1fr; /* Two columns of equal width */
        gap: 20px; /* Space between columns */
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      /* Add responsive styles */
      @media only screen and (max-width: 600px) {
        .modal-content {
          width: 90%;
        }

        #rowDetailsForm {
          grid-template-columns: 1fr; /* One column on smaller screens */
        }
      }

      /* Add responsive styles */
      @media only screen and (max-width: 600px) {
        .tb-title h3 {
          font-size: 14px;
        }

        td {
          font-weight: 600;
          font-size: 8px;
        }

        .heading span {
          font-size: 6px;
        }

        .arrow {
          border-width: 0 1px 1px 0;
          padding: 2px;
        }
      }

      .table-container {
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <div class="table-title">
      <div class="tb-title">
        <h3>Travel History</h3>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr class="column_heading">
            <th id="hide_name">Name</th>
            <th>Sr. No.</th>
            <th>Is Local Conveyance</th>
            <th>From Location</th>
            <th>Date and Time Start</th>
            <th>To Location</th>
            <th>Date and Time End</th>
            <th>Purpose</th>
            <th>Mode of Transport</th>
            <th>Travel KM</th>
            <th>Fare Amt</th>
            <th>DA</th>
            <th>Halting Amt</th>
            <th>Lodging Amt</th>
            <th>Local Expense Amt</th>
            <th>Total</th>
            <th>Total Visit Hour</th>
            <th>City Class</th>
            <th>DA Claimed</th>
            <th>Uploaded Ticket Image</th>
            <th>Uploaded Lodging Bill Image</th>
            <th>No. of Day Stay Lodge</th>
          </tr>
        </thead>
        <tbody id="ta_chart_table_body">
          {% for index, row in enumerate(data) %}
          <tr
            class="row_custom_border {{ 'hidden' if index >= 5 else '' }}"
            onclick="showRowDetails({{ index }})"
          >
            <td id="hide_name">{{ row.name }}</td>

            <td>{{ index + 1 }}</td>
            <td>{{ row.local_conveyance }}</td>
            <td>{{ row.from_location }}</td>
            <td>{{ row.date_and_time_start }}</td>
            <td>{{ row.to_location }}</td>
            <td>{{ row.date_and_time_end }}</td>
            <td>{{ row.purpose }}</td>
            <td>{{ row.mode_of_transport }}</td>
            <td>{{ row.kilometer_of_travelling }}</td>
            <td>₹{{ row.fare_amount }}</td>
            <td>₹{{ row.daily_allowance }}</td>
            <td>₹{{ row.halting_amount }}</td>
            <td>₹{{ row.lodging_amount }}</td>
            <td>₹{{ row.local_conveyance_other_expenses_amount }}</td>
            <td class="total-amt">₹{{ row.total }}</td>
            <td>{{ row.total_visit_hour }}</td>
            <td>{{ row.city_class }}</td>
            <td>{{ row.da_claimed }}</td>
            <td>
              <a
                href="#"
                onclick="openImage('{{ row.uploaded_ticket_image }}', 'Ticket Image')"
              >
                View Ticket Image
              </a>
            </td>
            <td>
              <a
                href="#"
                onclick="openImage('{{ row.uploaded_lodging_bill_image }}', 'Lodging Bill Image')"
              >
                View Lodging Bill Image
              </a>
            </td>

            <td>{{ row.day_stay_lodge }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Modal Popup Dialog Box -->
    <div id="rowDetailsDialog" class="modal">
      <div class="modal-content">
        <span class="close_icon" onclick="closeRowDetails()" title="Close">
          <img src="/files/close.png" alt="Close" />
        </span>
        <div class="modal_header">
          <h3 id="modalTitle">Row Details</h3>
          <div style="text-align: right; margin-top: 20px">
            <button type="button" onclick="editRow()">Edit</button>
            <button id="deleteBtn" type="button" onclick="deleteRow()">
              Delete
            </button>
          </div>
        </div>
        <form id="rowDetailsForm">
          <!-- Form fields will be added here dynamically -->
        </form>
      </div>
    </div>

    <div>
      <button id="load-more-btn" onclick="loadMore()">Show More</button>
      <button id="show-less-btn" style="display: none" onclick="showLess()">
        Show Less
      </button>
    </div>

    <script>

      function openImage(imageSrc, altText) {

        // Extract the image name from the image source
        const imageName = imageSrc.substring(imageSrc.lastIndexOf('/') + 1);

        // Create a new window with the image
        const imageWindow = window.open("", "_blank");

        // Write HTML content to the new window
        imageWindow.document.write(`
                    <html>
                      <head>
                        <title>${imageName}</title>
                        <style>
                          body {
                            margin: 0;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            height: 100vh;
                          }
                          img {
                            max-width: 90%;
                            max-height: 90%;
                          }
                        </style>
                      </head>
                      <body>
                        <img src="${imageSrc}" alt="${altText}" />
                      </body>
                    </html>
                  `);
      }


      // Define the 'data' variable here by rendering it in a <script> tag
      const data = {{ data | tojson | safe }};

      const fieldToHeadingMap = {
        local_conveyance: "Is Local Conveyance",
        from_location: "From Location",
        date_and_time_start: "Date and Time Start",
        to_location: "To Location",
        date_and_time_end: "Date and Time End",
        purpose: "Purpose",
        mode_of_transport: "Mode of Transport",
        kilometer_of_travelling: "Travel KM",
        fare_amount: "Fare Amt",
        daily_allowance: "DA",
        halting_amount: "Halting Amt",
        lodging_amount: "Lodging Amt",
        local_conveyance_other_expenses_amount: "Local Expense Amt",
        total: "Total",
        total_visit_hour: "Total Visit Hour",
        city_class: "City Class",
        da_claimed: "DA Claimed",
        uploaded_ticket_image: "Uploaded Ticket Image",
        uploaded_lodging_bill_image: "Uploaded Lodging Bill Image",
        day_stay_lodge: "No. of Day Stay Lodge"
      };

      function showRowDetails(rowIndex) {
        const rowData = data[rowIndex]; // Assuming 'data' is your array of row data
        const rowDetailsForm = document.getElementById("rowDetailsForm");
        rowDetailsForm.innerHTML = ""; // Clear previous form fields

        // Set custom title
        document.getElementById("modalTitle").textContent = `Details for Row ${
            rowIndex + 1
        }`;

                    // Iterate over the properties of the row data and create input fields dynamically
                    for (const key in rowData) {
                      if (rowData.hasOwnProperty(key)) {
                        const value = rowData[key];

                         // Check if the field has a corresponding label in the fieldToHeadingMap
                        if (!fieldToHeadingMap.hasOwnProperty(key)) continue;


                        const formGroup = document.createElement("div");
                        formGroup.classList.add("form-group");

                        const label = document.createElement("label");
                        label.textContent = fieldToHeadingMap[key] + ":";
                        formGroup.appendChild(label);

                        let input;
                        if (typeof value === "boolean") {
                          input = document.createElement("input");
                          input.type = "checkbox";
                          input.checked = value;
                          input.readOnly = true;
                        } else if (typeof value === "string" && value.length > 100) {
                          input = document.createElement("textarea");
                          input.rows = 4;
                          input.value = value;
                          input.readOnly = true;
                        }  else if (key === "uploaded_ticket_image" || key === "uploaded_lodging_bill_image") {
                          // For image links, create an anchor element that opens the image in a new tab
                          input = document.createElement("a");
                          input.href = value;
                          input.textContent = "View Image";
                          input.title = `Path: ${value}`;
                          input.target = "_blank";
                        }  else {
                          input = document.createElement("input");
                          input.type = "text";
                          input.value = value;
                          input.readOnly = true;
                        }

                        formGroup.appendChild(input);
                        rowDetailsForm.appendChild(formGroup);
                      }
                    }

                    // Show the dialog box
                    const rowDetailsDialog = document.getElementById("rowDetailsDialog");
                    rowDetailsDialog.style.display = "block";

                    // Set the delete button to pass the index to deleteRow function
            const deleteBtn = document.getElementById("deleteBtn");
            deleteBtn.setAttribute("data-row-index", rowIndex);
                  }


                  function closeRowDetails() {
                    const rowDetailsDialog = document.getElementById("rowDetailsDialog");
                    rowDetailsDialog.style.display = "none";
                  }

                  window.addEventListener("click", function (event) {
                    const modal = document.getElementById("rowDetailsDialog");
                    if (event.target == modal) {
                      modal.style.display = "none";
                    }
                  });

                  // Example edit and delete functions (placeholders)
                  function editRow() {
                    alert("Edit functionality to be implemented");
                  }

                  function deleteRow() {
                    const rowIndex = parseInt(document.getElementById("deleteBtn").getAttribute("data-row-index"));
                    const rowData = data[rowIndex]; // Assuming 'data' is your array of row data
                    const recordName = rowData.name; // Assuming 'name' is the unique identifier for the record

                    if (confirm("Are you sure you want to delete this record?")) {
                        // Send an AJAX request to the server to delete the record
                        frappe.call({
                            method: 'travel_allowance.travel_allowance.doctype.travel_allowance.travel_allowance.delete_ta_record',
                            args: {
                                record_name: recordName
                            },
                            callback: function(response) {
                                // Check if the deletion was successful
                                if (response.message === 'success') {
                                    alert('Record deleted successfully.');
                                    closeRowDetails(); // Close the modal after successful deletion

                                    // Remove the row from the table
                                    const tableBody = document.getElementById("ta_chart_table_body");
                                    const row = tableBody.getElementsByTagName("tr")[rowIndex];
                                    tableBody.removeChild(row);

                                    // Update the data array
                                    data.splice(rowIndex, 1);

                                    // Update row indices in the table and delete button
                                    const rows = tableBody.getElementsByTagName("tr");
                                    for (let i = 0; i < rows.length; i++) {
                                        rows[i].onclick = function() { showRowDetails(i); };
                                        rows[i].getElementsByTagName("td")[1].textContent = i + 1; // Update Sr. No.
                                    }
                                    // Refresh the page to reflect changes
                                    location.reload();
                                } else {
                                    alert('Failed to delete record.');
                                }
                            }
                        });
                    }
                }



                let startIndex = 5; // Starting index for loading more rows
                let rowsPerPage = 5; // Number of rows to display per click
                let initialRowCount = 5; // Initial number of rows

                function loadMore() {
                  let tableBody = document.getElementById("ta_chart_table_body");
                  let rows = tableBody.getElementsByTagName("tr");

                  for (
                    let i = startIndex;
                    i < startIndex + rowsPerPage && i < rows.length;
                    i++
                  ) {
                    rows[i].classList.remove("hidden"); // Display the next set of rows
                  }

                  startIndex += rowsPerPage;

                  // Show the "Show Less" button when additional rows are displayed
                  if (startIndex < rows.length) {
                    document.getElementById("show-less-btn").style.display =
                      "inline-block";
                  }

                  // Hide the "Load More" button if all rows are displayed
                  if (startIndex >= rows.length) {
                    document.getElementById("load-more-btn").style.display = "none";
                  }

                  // Hide the "Show Less" button when only the initial set of rows is displayed
                  if (startIndex <= initialRowCount) {
                    document.getElementById("show-less-btn").style.display = "none";
                  }
                }

                function showLess() {
                  // Update startIndex to point to the previous set of rows
                  startIndex -= rowsPerPage;

                  let tableBody = document.getElementById("ta_chart_table_body");
                  let rows = tableBody.getElementsByTagName("tr");

                  // Hide the last set of displayed rows
                  for (
                    let i = startIndex;
                    i < startIndex + rowsPerPage && i < rows.length;
                    i++
                  ) {
                    rows[i].classList.add("hidden");
                  }

                  // Show the "Load More" button
                  document.getElementById("load-more-btn").style.display = "inline-block";

                  // Hide the "Show Less" button if we're back to the initial state
                  if (startIndex <= initialRowCount) {
                    document.getElementById("show-less-btn").style.display = "none";
                  }
                }
    </script>
  </body>
</html>
